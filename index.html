<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocas/4.2.3/tocas.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocas/4.2.3/tocas.min.js"></script>
    <style>
        #main-blk {
            padding-bottom: 3rem;
        }

        #go-page-top-btn {
            position: fixed;
            right: 10px;
            bottom: 5px;
        }
    </style>
</head>

<body>
    <div class="ts-app-topbar">
        <div class="start">
            <div class="item is-text">拉麵資訊.台灣</div>
        </div>
        <div class="end">
            <a class="item">
                <span class="ts-icon is-ellipsis-vertical-icon"></span>
            </a>
        </div>
    </div>

    <div id="main-blk" class="ts-content is-vertically-padded">
        <div class="ts-progress is-processing">
            <div id="progress-bar" class="bar" style="--value: 0">
                <div class="text">0%</div>
            </div>
        </div>
        <div class="ts-row" style="padding-top: 20px;">
            <div class="column is-fluid">
                <div class="ts-input is-fluid">
                    <input
                        id="search-keyword"
                        type="text"
                        class="input"
                        placeholder="豚骨 / 雞白 / 沾麵 / 名店 / ..." />
                </div>
            </div>
            <div class="column">
                <button id="search-btn" onclick="search()" class="ts-button is-icon" data-tooltip="搜尋">
                    <span class="ts-icon is-magnifying-glass-icon"></span>
                </button>
            </div>
            <div class="column">
                <button onclick="gotoLucky()" class="ts-button is-icon" data-tooltip="好手氣">
                    <span class="ts-icon is-shuffle-icon"></span>
                </button>
            </div>
        </div>
        <div class="ts-wrap is-center-aligned is-middle-aligned" style="padding-top: 20px; padding-bottom: 10px;">
            <div class="ts-select is-solid">
                <select>
                    <option>不限時間</option>
                    <option>今日營業</option>
                    <option>現在營業</option>
                </select>
            </div>
            <div class="ts-select is-solid">
                <select id="show-eat-option" onchange="search()">
                    <option>顯示所有</option>
                    <option>已經吃過</option>
                    <option>還沒吃過</option>
                </select>
            </div>
            <button class="ts-button is-icon is-negative is-outlined" data-toggle="modal:is-visible">
                <span class="ts-icon is-trash-icon"></span>
            </button>
            <div class="ts-modal" data-name="modal">
                <div class="content">
                    <div class="ts-content is-padded">
                        <p>你確定要清除所有資料嗎？</p>
                        <p>你確定要清除所有資料嗎？</p>
                        <p>你確定要清除所有資料嗎？</p>
                    </div>
                    <div class="ts-divider"></div>
                    <div class="ts-content is-tertiary is-horizontally-padded is-end-aligned">
                        <button class="ts-button is-negative is-outlined" data-toggle="modal:is-visible"
                            onclick="resetItemState()">
                            確定
                        </button>
                        <button class="ts-button" data-toggle="modal:is-visible">
                            關閉
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="ts-box">
            <table class="ts-table is-celled is-striped">
                <thead>
                    <tr>
                        <th class="is-collapsed"></th>
                        <th class="is-collapsed mobile:u-hidden">營業時間</th>
                        <th>名稱</th>
                        <th>預約</th>
                        <th>排隊登記</th>
                        <th class="mobile:u-hidden">標籤</th>
                    </tr>
                </thead>
                <tbody id="ramen-info-list"></tbody>
            </table>
            <div class="ts-wrap is-center-aligned">
                <div id="skeleton" class="ts-loading"></div>
            </div>
        </div>
    </div>
    <div id="go-page-top-btn" class="u-hidden">
        <button onclick="goPageTop()" class="ts-button is-icon" data-tooltip="回頂端">
            <span class="ts-icon is-arrow-up-icon"></span>
        </button>
    </div>
</body>

<script src="./assets/js/awesome.js"></script>
<script>
    function getItemCheckedSet() {
        return new Set(JSON.parse(localStorage.getItem('checked_list') || '[]'));
    }

    function goPageTop() {
        window.scrollTo(0, 0);
    }

    function search() {
        function isMatchKeyword(keyword, item) {
            for (const key in item) {
                if (item[key] !== null && item[key].indexOf(searchKeyword) >= 0) {
                    return true;
                }
            }

            return false;
        }

        function isMatchShowEatOption(index, showEatOption, checkedSet) {
            switch (showEatOption) {
                case '顯示所有':
                    return true
                case '還沒吃過':
                    return !checkedSet.has(index);
                case '已經吃過':
                    return checkedSet.has(index);
                default:
                    console.error(`unhandled show-eat-option '${showEatOption}'`);
                    return false;
            }
        }

        const searchKeyword = document.querySelector('#search-keyword').value.trim();
        const showEatOption = document.querySelector('#show-eat-option').value;
        const checkedSet = getItemCheckedSet();

        let hitCnt = 0;
        for (let i=0; i < awesome_list.length; ++i) {
            const itemTr = document.querySelector(`#ramen-info-item-${i}`)
            const item = awesome_list[i];

            if (
                (searchKeyword !== '' && !isMatchKeyword(searchKeyword, item))
                || !isMatchShowEatOption(i, showEatOption, checkedSet)
            ) {
                itemTr.classList.add('u-hidden');
            } else {
                itemTr.classList.remove('u-hidden');
                ++hitCnt;
            }
        }

        const noResultTr = document.querySelector('#ramen-info-no-result');
        if (hitCnt > 0)  {
            noResultTr.classList.add('u-hidden');
        } else {
            noResultTr.classList.remove('u-hidden');
        }
    }

    /**
     * @param {!Array<number>} addList
     * @param {!Array<number>} subList
     */
    function updateItemState(addList, subList) {
        let checkedSet = getItemCheckedSet();

        for (const index of addList) {
            checkedSet.add(index);
        }

        for (const index of subList) {
            checkedSet.delete(index);
        }

        const checkedList = [...checkedSet];
        checkedList.sort();
        localStorage.setItem("checked_list", JSON.stringify(checkedList));
    }

    function refreshItemState() {
        const checkedSet = getItemCheckedSet();

        for (const index of awesome_list.keys()) {
            document.querySelector(`#item-${index}-checked`).checked = checkedSet.has(index);
        }

        const progressRatio = Math.round(checkedSet.size / awesome_list.length * 100);
        const progressBar = document.querySelector('#progress-bar');
        progressBar.style = `--value: ${progressRatio}`;
        progressBar.firstElementChild.innerHTML = `${progressRatio}%`;
    }

    function resetItemState() {
        updateItemState([], [...Array(awesome_list.length).keys()]);
        refreshItemState();
        search();
    }

    function gotoLucky() {
        const luckyID = "ramen-info-item-" + Math.floor(Math.random() * awesome_list.length);
        document.getElementById(luckyID).classList.add("is-indicated");
        location.hash = "#" + luckyID;
    }

    function changeItem(index) {
        if (document.getElementById(`item-${index}-checked`).checked) {
            updateItemState([index], []);
        }
        else {
            updateItemState([], [index]);
        }

        refreshItemState();
        search();
    }

    function init() {
        const items = [];
        awesome_list.forEach((element, index) => {
            items[index] = `
            <tr id="ramen-info-item-${index}">
                <td>
                    <label class="ts-checkbox">
                        <input type="checkbox" id="item-${index}-checked" onchange="changeItem(${index})"/>
                    </label>
                </td>
                <td class="mobile:u-hidden"><span class="ts-icon is-battery-full-icon"></span></td>
                <td>
                    <a href="https://google.com/" target="_blank"
                        rel="noopener">${element["名稱"]}</a>
                </td>
                <td>${element["預約"] || "N/A"}</td>
                <td>${element["排隊登記"] || "N/A"}</td>
                <td class="mobile:u-hidden">${element["標籤"] || "N/A"}</td>
            </tr>
            `;
        });
        items[awesome_list.length] = `
            <tr id="ramen-info-no-result" class="u-hidden">
                <td colspan="6" class="is-center-aligned">無資料</td>
            </tr>`;
        document.getElementById("ramen-info-list").innerHTML = items.join('');
        document.getElementById("skeleton").classList.add("u-hidden");
        refreshItemState();

        document.querySelector("#search-keyword").addEventListener('keyup', event => {
            if (event.keyCode === 13) {
                document.querySelector("#search-btn").click();
            }
        });

        window.onscroll = () => {
            const goPageTopBtn = document.querySelector("#go-page-top-btn");
            if (window.pageYOffset === 0) {
                goPageTopBtn.classList.add('u-hidden');
                return;
            }

            goPageTopBtn.classList.remove('u-hidden');
        };
    }

    init();
</script>

</html>